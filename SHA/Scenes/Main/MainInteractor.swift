//
//  MainInteractor.swift
//  SHA
//
//  Created by Ilyá Belsky on 4/25/18.
//  Copyright (c) 2018 Ilyá Belsky. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit


protocol MainBusinessLogic {
    func fetchRecord(request: Main.FetchRecord.Request)
    func increment(request: Main.Increment.Request)
    func reset(request: Main.Reset.Request)
    func navigate(request: Main.Navigate.Request)
    func share(request: Main.Share.Request)
}

protocol MainDataStore {
    var currentDate: RecordDate { get }
}

class MainInteractor: MainBusinessLogic, MainDataStore {
    var presenter: MainPresentationLogic?
    var worker = RecordsWorker(recordsStore: RecordsPlistStore())
    
    var currentDate = RecordDate()
    
    // MARK: - Records
    
    func fetchRecord(request: Main.FetchRecord.Request) {
        worker.fetchRecord(for: currentDate, completionHandler: { record in
            let response = Main.FetchRecord.Response(record: record)
            self.presenter?.presentRecord(response: response)
        })
    }

    // MARK: - Counters
    
    func increment(request: Main.Increment.Request) {
        worker.increment(counter: request.counter, for: currentDate) { record in
            let response = Main.FetchRecord.Response(record: record)
            self.presenter?.presentRecord(response: response)
        }
    }
    
    func reset(request: Main.Reset.Request) {
        worker.reset(counter: request.counter, for: currentDate) { record in
            let response = Main.FetchRecord.Response(record: record)
            self.presenter?.presentRecord(response: response)
        }
    }
    
    // MARK: - Navigation
    
    func navigate(request: Main.Navigate.Request) {
        switch request.direction {
        case .next:
            currentDate = currentDate.tomorrow()
        case .prev:
            currentDate = currentDate.yesterday()
        }
        fetchRecord(request: Main.FetchRecord.Request())
    }
    
    // MARK: - Share
    
    func share(request: Main.Share.Request) {
        let month = Calendar.current.component(.month, from: currentDate.rawDate)
        worker.fetchRecords(for: month) { records in
            let response = Main.Share.Response(month: month, records: records)
            self.presenter?.presentShareReport(response: response)
        }
    }
}
